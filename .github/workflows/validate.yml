name: Validate Filter Lists

on:
  push:
    paths:
      - 'Lists/**'
      - 'metadata.json'
  pull_request:
    paths:
      - 'Lists/**'
      - 'metadata.json'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0  # necessario per leggere tag

      - name: Smart validation + metadata chores
        shell: bash
        run: |
          echo "Starting smart validation and metadata update..."
          ERRORS=0
          DATE=$(date -I)
          REPO_VERSION=$(git describe --tags --abbrev=0 || echo "v0.0.1")

          # Aggiorna versione repo
          jq --arg version "$REPO_VERSION" '.repo.version = $version' metadata.json > metadata.tmp && mv metadata.tmp metadata.json

          while IFS= read -r -d '' file; do
            echo "Processing $file..."
            cp "$file" "$file.bak"
            sed -i '1s/^\xEF\xBB\xBF//' "$file"

            # Convert CRLF -> LF
            if grep -q $'\r' "$file"; then
              sed -i 's/\r$//' "$file"
            fi

            # NULL bytes
            if LC_ALL=C grep -Pq '\x00' "$file" 2>/dev/null; then
              LC_ALL=C grep -Pn '\x00' "$file" 2>/dev/null | while IFS=: read -r lineno _; do
                echo "WARNING: NULL byte in $file at line $lineno"
              done
            fi

            # Empty file
            [ ! -s "$file" ] && { echo "ERROR: $file is empty"; ERRORS=$((ERRORS+1)); }

            # Trailing whitespace, denyallow, broad wildcard checks
            while IFS= read -r line || [ -n "$line" ]; do
              [[ -z "$line" || "$line" =~ ^! ]] && continue
              [[ "$line" =~ [[:space:]]+$ ]] && echo "WARNING: Trailing whitespace -> $line"
              [[ "$line" =~ denyallow ]]  && echo "WARNING: denyallow -> $line"
              [[ "$line" =~ \|\|\* ]]     && echo "WARNING: broad wildcard -> $line"
            done < "$file"

            # Duplicate lines
            DUP_LINES=$(awk '!/^!/ && NF{print}' "$file" | sort | uniq -d)
            [ -n "$DUP_LINES" ] && echo "WARNING: Duplicate lines in $file"

            # --- AUTOMAZIONI METADATA ---
            RELPATH=$(realpath --relative-to="$GITHUB_WORKSPACE" "$file")
            HASH=$(sha256sum "$file" | awk '{print $1}')

            # Aggiorna hash e last_updated in metadata.json
            jq --arg file "$RELPATH" --arg hash "$HASH" --arg date "$DATE" \
              '(.lists[] | select(.url==$file)).hash = $hash | (.lists[] | select(.url==$file)).last_updated = $date' \
              metadata.json > metadata.tmp && mv metadata.tmp metadata.json

            # Aggiorna header last_updated della lista
            if grep -q '^! Last updated:' "$file"; then
              sed -i "1s/^! Last updated:.*/! Last updated: $DATE/" "$file"
            else
              sed -i "1i! Last updated: $DATE" "$file"
            fi

          done < <(find Lists -type f -name "*.txt" -print0)

          if [ $ERRORS -gt 0 ]; then
            echo "Validation completed with $ERRORS critical error(s)."
            exit 1
          else
            echo "Validation completed successfully. Warnings may exist."
          fi
