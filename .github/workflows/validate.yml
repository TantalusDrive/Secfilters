name: Validate Filter Lists

on:
  push:
    paths:
      - 'Lists/**'
  pull_request:
    paths:
      - 'Lists/**'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1

      - name: Smart validation of filter lists
        shell: bash
        run: |
          echo "Starting optimized smart validation..."
          ERRORS=0

          while IFS= read -r -d '' file; do
            echo "Checking $file..."
            cp "$file" "$file.bak"
            sed -i '1s/^\xEF\xBB\xBF//' "$file"

            if grep -q $'\r' "$file"; then
              echo "NOTICE: Converting CRLF to LF in $file"
              sed -i 's/\r$//' "$file"
            fi

            if LC_ALL=C grep -Pq '\x00' "$file" 2>/dev/null; then
              LC_ALL=C grep -Pn '\x00' "$file" 2>/dev/null | while IFS=: read -r lineno _; do
                echo "WARNING: NULL byte found in $file at line $lineno"
              done
            fi

            [ ! -s "$file" ] && { echo "ERROR: $file is empty"; ERRORS=$((ERRORS+1)); }

            while IFS= read -r line || [ -n "$line" ]; do
              [[ -z "$line" || "$line" =~ ^! ]] && continue

              [[ "$line" =~ [[:space:]]+$ ]] && echo "WARNING: Trailing whitespace in $file -> $line"
              [[ "$line" =~ denyallow ]]  && echo "WARNING: $file contains denyallow -> $line"
              [[ "$line" =~ \|\|\* ]]     && echo "WARNING: $file contains broad wildcard network filter -> $line"

              cleaned=$(echo "$line" | sed -E 's/\$(document|frame|popup|important)$//')

              [[ "$cleaned" =~ \|\|.+\|\| ]] && echo "WARNING: Multiple pipe detected in $file -> $line"

              skip=false
              if [[ "$line" =~ ^(##\+js|##:matches-css) ]]; then
                if [[ "$line" == *xn--* || "$line" == *favicon* ]]; then skip=true; fi
                if [[ "$line" =~ \(.*,.*,.+ ]]; then skip=true; fi
                if [[ "$line" =~ \$document|\$frame|\$popup|\$important ]]; then skip=true; fi
              fi
              $skip && continue

              [[ "$cleaned" =~ /[^/][[:space:]]*$ ]] && echo "WARNING: Possible malformed regex in $file -> $line"

            done < "$file"

            DUP_LINES=$(awk '!/^!/ && NF{print}' "$file" | sort | uniq -d)
            [ -n "$DUP_LINES" ] && { echo "WARNING: Duplicate lines in $file"; echo "$DUP_LINES"; }

          done < <(find Lists -type f -name "*.txt" -print0)

          if [ $ERRORS -gt 0 ]; then
            echo "Validation completed with $ERRORS critical error(s)."
            exit 1
          else
            echo "Validation completed successfully. Warnings may exist."
          fi
