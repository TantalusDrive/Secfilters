name: Validate Filter Lists

on:
  push:
    paths:
      - 'Lists/**'
  pull_request:
    paths:
      - 'Lists/**'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Smart validation of filter lists
        shell: bash
        run: |
          echo "Starting smart validation..."
          ERRORS=0

          for file in $(find Lists -type f -name "*.txt"); do
            echo "Checking $file..."

            # Backup file (always overwrite the previous one)
            cp "$file" "$file.bak"

            # Remove BOM
            sed -i '1s/^\xEF\xBB\xBF//' "$file"

            # Convert CRLF â†’ LF
            if grep -q $'\r' "$file"; then
              echo "NOTICE: Converting CRLF to LF in $file"
              sed -i 's/\r$//' "$file"
            fi

            # NULL bytes (warning only)
            if grep -q $'\x00' "$file"; then
              grep -Pn $'\x00' "$file" | while IFS=: read -r lineno _; do
                echo "WARNING: NULL byte detected in $file at line $lineno"
              done
            fi

            # 1. File empty (critical)
            [ ! -s "$file" ] && { echo "ERROR: $file is empty"; ERRORS=$((ERRORS+1)); }

            # 2. Trailing whitespace (warning)
            grep -En '[[:space:]]+$' "$file" || true && echo "WARNING: Trailing whitespace detected in $file"

            # 3. Duplicate lines (non-comment, non-empty)
            DUP_LINES=$(awk '!/^!/ && NF{print}' "$file" | sort | uniq -d)
            [ -n "$DUP_LINES" ] && { echo "WARNING: Duplicate lines detected in $file"; echo "$DUP_LINES"; }

            # 4. Malformed comment characters
            grep -En '^!.*[^[:print:][:space:]]' "$file" || true && echo "WARNING: Non-printable characters in comments in $file"

            # 5. Security-oriented checks (warning)
            grep -F '\$all' "$file" || true && echo "WARNING: $file contains \$all"
            grep -F 'important' "$file" || true && echo "WARNING: $file contains important"
            grep -F 'denyallow' "$file" || true && echo "WARNING: $file contains denyallow"
            grep -F '||*' "$file" || true && echo "WARNING: $file contains broad wildcard network filter"
            grep -EP '^/.+[^/][[:space:]]*$' "$file" || true && echo "WARNING: Possible malformed regex in $file"

          done

          if [ $ERRORS -gt 0 ]; then
            echo "Validation completed with $ERRORS critical error(s)."
            exit 1
          else
            echo "Validation completed successfully. Warnings may exist."
          fi
