name: Validate Filter Lists

on:
  push:
    paths:
      - 'Lists/**'
  pull_request:
    paths:
      - 'Lists/**'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Smart validation of filter lists
        shell: bash
        run: |
          echo "Starting smart validation..."
          ERRORS=0

          while IFS= read -r -d '' file; do
            echo "Checking $file..."

            cp "$file" "$file.bak"

            # Remove BOM
            sed -i '1s/^\xEF\xBB\xBF//' "$file"

            # Convert CRLF â†’ LF
            if grep -q $'\r' "$file"; then
              echo "NOTICE: Converting CRLF to LF in $file"
              sed -i 's/\r$//' "$file"
            fi

            # NULL bytes (detect + remove correctly)
            if LC_ALL=C grep -Pq '\x00' "$file"; then
              LC_ALL=C grep -Pn '\x00' "$file" | while IFS=: read -r lineno _; do
                echo "NOTICE: Removing NULL byte in $file at line $lineno"
              done
              tr -d '\000' < "$file" > "$file.tmp" && mv "$file.tmp" "$file"
            fi

            # 1. File empty (critical)
            if [ ! -s "$file" ]; then
              echo "ERROR: $file is empty"
              ERRORS=$((ERRORS+1))
            fi

            # 2. Trailing whitespace (warning)
            if grep -En '[[:space:]]+$' "$file"; then
              echo "WARNING: Trailing whitespace detected in $file"
            fi

            # 3. Duplicate lines (non-comment, non-empty)
            DUP_LINES=$(awk '!/^!/ && NF{print}' "$file" | sort | uniq -d)
            if [ -n "$DUP_LINES" ]; then
              echo "WARNING: Duplicate lines detected in $file"
              echo "$DUP_LINES"
            fi

            # 4. Malformed comment characters
            if grep -En '^!.*[^[:print:][:space:]]' "$file"; then
              echo "WARNING: Non-printable characters in comments in $file"
            fi

            # 5. Security-oriented checks (warning)
            grep -F '\$all' "$file"       && echo "WARNING: $file contains \$all"
            grep -F 'important' "$file"  && echo "WARNING: $file contains important"
            grep -F 'denyallow' "$file"  && echo "WARNING: $file contains denyallow"
            grep -F '||*' "$file"        && echo "WARNING: $file contains broad wildcard network filter"
            grep -E '^/.+[^/][[:space:]]*$' "$file" && echo "WARNING: Possible malformed regex in $file"

          done < <(find Lists -type f -name "*.txt" -print0)

          if [ $ERRORS -gt 0 ]; then
            echo "Validation completed with $ERRORS critical error(s)."
            exit 1
          else
            echo "Validation completed successfully. Warnings may exist."
          fi
